apiVersion: batch/v1
kind: Job
metadata:
  name: ${JOB_NAME}
  namespace: ${NAMESPACE}
spec:
  template:
    spec:
      serviceAccountName: default # Uses the SA configured by the deploy script
      containers:
      - name: tls-scanner
        image: ${SCANNER_IMAGE}
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c"]
        args:
          - |
            # Run the scanner in the background and capture its exit code
            /usr/local/bin/tls-scanner --all-pods --json-file /artifacts/results.json --csv-file /artifacts/results.csv --log-file /artifacts/scan.log ${NAMESPACE_FILTER_ARG} ${LIMIT_IPS_ARG} &
            
            SCANNER_PID=$!
            
            # Stream the log file in real-time to stdout (--retry waits for file creation)
            tail -f --retry /artifacts/scan.log &
            TAIL_PID=$!
            
            # Wait for the scanner to complete
            wait $SCANNER_PID
            exit_code=$?
            
            # Stop tailing and give it a moment to flush
            kill $TAIL_PID 2>/dev/null || true
            sleep 2
            
            # Dump any remaining log content to ensure nothing is missed
            echo ""
            echo "=========================================="
            echo "Scanner finished with exit code: $exit_code"
            echo "=========================================="
            
            # Keep the container alive to allow artifact collection
            echo "Pausing for log and artifact collection..."
            sleep 300
            exit $exit_code
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
          limits:
            cpu: 500m
            memory: 512Mi
        securityContext:
          privileged: true
        volumeMounts:
        - name: artifacts
          mountPath: /artifacts
      restartPolicy: Never
      volumes:
      - name: artifacts
        emptyDir: {}
  backoffLimit: 2
